<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Dino Run - Google Style</title>
    <style>
        /* Phong cách Google Chrome Offline */
        body {
            background-color: #f7f7f7;
            color: #535353;
            font-family: 'Courier New', Courier, monospace;
            text-align: center;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        canvas {
            border-bottom: 2px solid #535353;
            /* Mặt đất */
            background: transparent;
        }

        #scoreBoard {
            font-size: 24px;
            font-weight: bold;
            color: #535353;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .btn {
            margin-top: 30px;
            padding: 10px 25px;
            background: transparent;
            color: #535353;
            border: 2px solid #535353;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn:hover {
            background: #535353;
            color: white;
        }
    </style>
</head>

<body>

    <div id="scoreBoard">HI 00000</div>
    <canvas id="gameCanvas" width="600" height="150"></canvas>

    <p style="color: #999; font-size: 14px; margin-top: 10px;">Nhấn <b>SPACE</b> hoặc <b>↑</b> để nhảy</p>
    <a href="/" class="btn">QUAY LẠI</a>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        let score = 0;
        let gameSpeed = 6;
        let gravity = 0.6;
        let isGameOver = false;
        let frame = 0; // Biến đếm để tạo hiệu ứng chạy

        let dino = {
            x: 50,
            y: 110, // Mặt đất ở y=110
            width: 40,
            height: 43,
            dy: 0,
            jumpPower: -12,
            grounded: true,
            legFrame: 0 // 0: Chân trước, 1: Chân sau
        };

        let cactus = {
            x: 600,
            y: 115,
            width: 24,
            height: 46
        };

        // --- VẼ DINO (GOOGLE STYLE) ---
        function drawDino(x, y, legFrame) {
            ctx.fillStyle = "#535353"; // Màu xám đặc trưng

            // 1. Vẽ Đầu
            ctx.fillRect(x + 20, y, 20, 15);      // Hộp sọ
            ctx.fillRect(x + 20, y + 15, 12, 5);  // Mõm dưới

            // Mắt trắng
            ctx.fillStyle = "#f7f7f7";
            ctx.fillRect(x + 24, y + 4, 4, 4);
            ctx.fillStyle = "#535353"; // Trả lại màu xám

            // 2. Vẽ Thân
            ctx.fillRect(x, y + 15, 25, 20);      // Thân chính
            ctx.fillRect(x + 25, y + 20, 5, 8);   // Tay nhỏ

            // 3. Vẽ Đuôi
            ctx.fillRect(x - 5, y + 18, 5, 10);   // Gốc đuôi

            // 4. Vẽ Chân (Hiệu ứng chạy)
            if (dino.grounded) {
                if (legFrame === 0) {
                    // Chân trái bước
                    ctx.fillRect(x + 5, y + 35, 5, 8);
                    ctx.fillRect(x + 15, y + 35, 5, 5);
                } else {
                    // Chân phải bước
                    ctx.fillRect(x + 5, y + 35, 5, 5);
                    ctx.fillRect(x + 15, y + 35, 5, 8);
                }
            } else {
                // Đang nhảy (co cả 2 chân)
                ctx.fillRect(x + 5, y + 35, 5, 5);
                ctx.fillRect(x + 15, y + 35, 5, 5);
            }
        }

        // --- VẼ XƯƠNG RỒNG ---
        function drawCactus(x, y) {
            ctx.fillStyle = "#535353";
            // Thân chính
            ctx.fillRect(x + 8, y, 8, 46);
            // Nhánh trái
            ctx.fillRect(x, y + 10, 4, 15);
            ctx.fillRect(x, y + 22, 8, 4);
            // Nhánh phải
            ctx.fillRect(x + 16, y + 8, 4, 15);
            ctx.fillRect(x + 16, y + 20, 8, 4);
        }

        // --- INPUT ---
        function jump(e) {
            if ((e.code === "Space" || e.code === "ArrowUp") && dino.grounded) {
                dino.dy = dino.jumpPower;
                dino.grounded = false;
            }
        }
        document.addEventListener("keydown", jump);
        document.addEventListener("touchstart", () => {
            if (dino.grounded) { dino.dy = dino.jumpPower; dino.grounded = false; }
        });

        // --- GAME LOOP ---
        function update() {
            if (isGameOver) return;
            requestAnimationFrame(update);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            frame++; // Tăng biến đếm frame

            // 1. Xử lý Dino
            dino.dy += gravity;
            dino.y += dino.dy;

            if (dino.y >= 110) {
                dino.y = 110;
                dino.dy = 0;
                dino.grounded = true;
            }

            // Đổi chân sau mỗi 10 frame (Tạo hiệu ứng chạy)
            if (frame % 10 === 0) {
                dino.legFrame = (dino.legFrame === 0) ? 1 : 0;
            }

            drawDino(dino.x, dino.y, dino.legFrame);

            // 2. Xử lý Xương rồng
            cactus.x -= gameSpeed;
            if (cactus.x + cactus.width < 0) {
                cactus.x = canvas.width + Math.random() * 300;
                score++;
                gameSpeed += 0.1;
                // Format điểm số 00123
                document.getElementById("scoreBoard").innerText = "HI " + String(score).padStart(5, '0');
            }

            drawCactus(cactus.x, cactus.y);

            // 3. Va chạm
            if (
                dino.x < cactus.x + cactus.width - 5 &&
                dino.x + 30 > cactus.x + 5 &&
                dino.y < cactus.y + cactus.height &&
                dino.y + 35 > cactus.y
            ) {
                isGameOver = true;

                // Vẽ chữ Game Over
                ctx.fillStyle = "#535353";
                ctx.font = "30px Courier New";
                ctx.fillText("G A M E  O V E R", 180, 80);

                sendScoreToBackend(score * 100);
            }
        }

        // --- GỬI ĐIỂM ---
        function sendScoreToBackend(finalScore) {
            let data = { "gameType": "dino", "score": finalScore };

            fetch('/api/game/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
                .then(resp => resp.text())
                .then(msg => {
                    if (msg.includes("chưa đăng nhập")) alert("⚠️ " + msg);
                    setTimeout(() => location.reload(), 1000); // Đợi 1s rồi reset
                });
        }

        update();
    </script>
</body>

</html>